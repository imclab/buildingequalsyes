if(!com)var com={};if(!com.modestmaps)com.modestmaps={};
com.modestmaps.Markers=function(b){this.drawn=[];this.modestmap=b;this.container=b.parent;this.div=document.createElement("div");this.div.setAttribute("id","modestmaps_markers");this.div.style.position="absolute";this.div.style.left="0px";this.div.style.top="0px";this.div.style.zIndex="200";this.container.appendChild(this.div);this.canvas=Raphael(this.div,this.container.offsetWidth,this.container.offsetHeight);var a=this;this.modestmap.addCallback("drawn",function(){a._redrawMarkers()});this.modestmap.addCallback("resized",
function(){a.surface.width=a.container.offsetWidth;a.surface.height=a.container.offsetHeight;a._redrawMarkers()})};com.modestmaps.Markers.prototype.drawPoints=function(b,a){var c=this._locatifyLatLons(b),e=c[0];c=c[1];this._registerMarker({type:"point",locations:e,extent:c,more:a});return this._actuallyDrawPoints(e,c,a)};
com.modestmaps.Markers.prototype.drawLines=function(b,a){var c=this._locatifyLatLons(b),e=c[0];this._registerMarker({type:"line",locations:e,extent:c[1],more:a});return this._actuallyDrawLines(e,draw_extent,a)};com.modestmaps.Markers.prototype.drawPolygons=function(b,a){var c=this._locatifyLatLons(b),e=c[0];c=c[1];this._registerMarker({type:"polygon",locations:e,extent:c,more:a});return this._actuallyDrawPolygons(e,c,a)};
com.modestmaps.Markers.prototype.drawBoundingBoxes=function(b,a){for(var c=a&&a.delimeter?a.delimeter:" ",e=[],d=b.length,f=0;f<d;f++){var g=b[f].split(c),k=[g[0],g[1]];g=[g[2],g[3]];var m=[g[0],k[1]],h=[k[0],g[1]];e.push([[k[0],k[1]],[m[0],m[1]],[g[0],g[1]],[h[0],h[1]],[k[0],k[1]]])}return this.drawPolygons(e,a)};
com.modestmaps.Markers.prototype.drawGeoJson=function(b,a){a||(a={});for(var c=[],e=b.length,d=0;d<e;d++){var f=b[d],g={};for(key in a)g[key]=a[key];g.properties=f.properties;f=f.geometry.type=="GeometryCollection"?f.geometry.geometries:[f.geometry];for(var k=f.length,m=0;m<k;m++){var h=f[m].type,l=f[m].coordinates;l=this._lonlat2latlon(l);if(h=="Point"||h=="MultiPoint"){if(h=="Point")l=[l];h=this.drawPoints(l,g);c.push(h)}else if(h=="Polygon"||h=="MultiPolygon"){h=this.drawPolygons(l,g);c.push(h)}else if(h==
"LineString"||h=="MultiLineString"){if(h=="LineString")l=[l];h=this.drawLines(l,g);c.push(h)}}}return c};com.modestmaps.Markers.prototype.purgeMarkers=function(b){if(b){if(b>=this.drawn.length)return;this.drawn=this.drawn.slice(0,b)}else this.drawn=[];this._redrawMarkers()};com.modestmaps.Markers.prototype._lonlat2latlon=function(b,a){if(b){if(typeof b[0]=="number")return[b[1],b[0]];a=[];for(var c=b.length,e=0;e<c;e++)a.push(this._lonlat2latlon(b[e]));return a}};
com.modestmaps.Markers.prototype._locatifyLatLons=function(b){var a=[];for(i in b)if(typeof b[i][0]==="object"){var c=this._locatifyLatLons(b[i]);a.push(c[0])}else{c=new com.modestmaps.Location(b[i][0],b[i][1]);a.push(c)}b=this._extentForPoints(a);return Array(a,b)};
com.modestmaps.Markers.prototype._registerMarker=function(b){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var e=Math.random()*16|0;return(c=="x"?e:e&3|8).toString(16)}).toUpperCase();a="marker-"+a;b.id=a;this.drawn.push(b);return a};com.modestmaps.Markers.prototype._scrubSurface=function(){this.canvas.clear()};
com.modestmaps.Markers.prototype._redrawMarkers=function(){this._scrubSurface();var b=this.modestmap.getExtent(),a=this.modestmap.getZoom();for(i in this.drawn){var c=this.drawn[i].type,e=this.drawn[i].locations,d=this.drawn[i].more;if(c=="point"&&a<14)this._actuallyDrawPoints(e,b,d);else if(c=="line")this._actuallyDrawLines(e,b,d);else c=="polygon"&&this._actuallyDrawPolygons(e,b,d)}};
com.modestmaps.Markers.prototype._actuallyDrawLines=function(b,a,c){a=[];for(var e in b){var d=[],f=b[e];if(f.length==1)f=f[0];for(var g in f){var k=this.modestmap.locationPoint(f[g]);d.push({x:k.x,y:k.y})}d=this._line(d,c);a.push(d)}return d};com.modestmaps.Markers.prototype._actuallyDrawPolygons=function(b,a,c){a=[];for(var e in b){var d=[],f=b[e];if(f.length==1)f=f[0];for(var g in f){var k=this.modestmap.locationPoint(f[g]);d.push({x:k.x,y:k.y})}d=this._polygon(d,c);a.push(d)}return a};
com.modestmaps.Markers.prototype._actuallyDrawPoints=function(b,a,c){a=[];for(i in b){var e=this.modestmap.locationPoint(b[i]);e=this._circle({x:e.x,y:e.y},c);a.push(e)}return a};com.modestmaps.Markers.prototype._radiusByZoomLevel=function(){return 5};
com.modestmaps.Markers.prototype._extentForDrawnPoints=function(){var b=undefined,a=undefined,c=undefined,e=undefined;for(i in this.drawn){var d=this.drawn[i].extent[0],f=this.drawn[i].extent[1];b=b===undefined?d.lat:Math.min(b,d.lat);a=a===undefined?d.lon:Math.min(a,d.lon);c=c===undefined?f.lat:Math.max(c,f.lat);e=e===undefined?f.lon:Math.max(e,f.lon)}d=new com.modestmaps.Location(b,a);f=new com.modestmaps.Location(c,e);return Array(d,f)};
com.modestmaps.Markers.prototype._extentForPoints=function(b){var a=b,c=undefined,e=undefined,d=b=undefined;if(typeof a[0].lat==="undefined"){var f=[];for(i in a)for(j in a[i])f.push(a[i][j]);a=f}for(i in a){c=c===undefined?a[i].lat:Math.min(c,a[i].lat);e=e===undefined?a[i].lon:Math.min(e,a[i].lon);b=b===undefined?a[i].lat:Math.max(b,a[i].lat);d=d===undefined?a[i].lon:Math.max(d,a[i].lon)}a=new com.modestmaps.Location(c,e);b=new com.modestmaps.Location(b,d);return Array(a,b)};
com.modestmaps.Markers.prototype._calculateDrawExtent=function(b,a){if(typeof a==="undefined")return this.modestmap.getExtent();var c=a.extentify_all?this.extentForDrawnPoints():b;a.extentify_redraw&&this.modestmap.setExtent(c);return c};
com.modestmaps.Markers.prototype._enpointifyByExtent=function(b,a){var c=this.modestmap.getExtent(),e=[];for(i in b){var d=b[i];if(typeof d.lat!=="number"){d=this._enpointifyByExtent(d,a);e.push(d)}else if(this._isContainedBy(d,a))if(this._isContainedBy(d,c)){d=this.modestmap.locationPoint(d);e.push(d)}}return e};com.modestmaps.Markers.prototype._isContainedBy=function(){return true};
com.modestmaps.Markers.prototype._polygon=function(b,a){for(var c=b.length,e=["M"+b[0].x+" "+b[0].y],d=1;d<c;d++)e.push("L"+b[d].x+" "+b[d].y);e.push("Z");return this._decorate(this.canvas.path(e.join("")),a)};com.modestmaps.Markers.prototype._line=function(b,a){for(var c=b.length,e=["M"+b[0].x+" "+b[0].y],d=1;d<c;d++)e.push("L"+b[d].x+" "+b[d].y);return this._decorate(this.canvas.path(e.join("")),a)};
com.modestmaps.Markers.prototype._circle=function(b,a){return this._decorate(this.canvas.circle(b.x,b.y,a&&a.radius?a.radius:8),a)};com.modestmaps.Markers.prototype._decorate=function(b,a){a&&a.attrs&&b.attr(a.attrs);a&&a.onload&&a.onload(b,a.properties);return b};(function(b){b.TouchHandler=function(){};b.TouchHandler.prototype={init:function(a){this.map=a;b.addEvent(a.parent,"touchstart",this.getDoubleTap());b.addEvent(a.parent,"touchstart",this.getTouchStart());b.addEvent(a.parent,"gesturestart",this.getGestureStart())},gestureStart:null,gestureChange:null,gestureCenter:null,gestureEnd:null,startCenter:null,startScale:undefined,startZoom:undefined,getGestureStart:function(){if(!this.gestureStart){var a=this;this.gestureStart=function(c){b.addEvent(a.map.parent,
"touchmove",a.getGestureCenter());b.addEvent(a.map.parent,"gesturechange",a.getGestureChange());b.addEvent(a.map.parent,"gestureend",a.getGestureEnd());a.startScale=c.scale;a.startZoom=a.map.getZoom();return b.cancelEvent(c)}}return this.gestureStart},getGestureCenter:function(){if(!this.gestureCenter){var a=this;this.gestureCenter=function(c){if(c.touches.length==2)a.startCenter=new b.Point((c.touches[0].pageX+c.touches[1].pageX)/2,(c.touches[0].pageY+c.touches[1].pageY)/2)}}return this.gestureCenter},
getGestureChange:function(){if(!this.gestureChange){var a=this;this.gestureChange=function(c){if(a.startScale!==undefined&&a.startZoom!==undefined){var e=Math.log(c.scale/a.startScale)/Math.log(2);e=Math.round(e);if(e!=0&&a.startCenter){var d=a.map.getZoom();a.map.zoomByAbout(a.startZoom+e-d,a.startCenter)}}return b.cancelEvent(c)}}return this.gestureChange},getGestureEnd:function(){if(!this.gestureEnd){var a=this;this.gestureEnd=function(c){b.removeEvent(a.map.parent,"gesturechange",a.getGestureChange());
b.removeEvent(a.map.parent,"touchmove",a.getGestureCenter());b.removeEvent(a.map.parent,"gestureend",a.getGestureEnd());a.startCenter=null;a.startScale=undefined;a.startZoom=undefined;return b.cancelEvent(c)}}return this.gestureEnd},touchStartHandler:null,getTouchStart:function(){if(!this.touchStartHandler){var a=this;this.touchStartHandler=function(c){if(c.touches.length==1){b.addEvent(document,"touchcancel",a.getTouchEnd());b.addEvent(document,"touchend",a.getTouchEnd());b.addEvent(document,"touchmove",
a.getTouchMove());a.prevTouch=new b.Point(c.changedTouches[0].pageX,c.changedTouches[0].pageY)}return b.cancelEvent(c)}}return this.touchStartHandler},touchMoveHandler:null,getTouchMove:function(){if(!this.touchMoveHandler){var a=this;this.touchMoveHandler=function(c){if(a.prevTouch&&c.touches.length==1){a.map.panBy(c.touches[0].pageX-a.prevTouch.x,c.touches[0].pageY-a.prevTouch.y);a.prevTouch.x=c.touches[0].pageX;a.prevTouch.y=c.touches[0].pageY}return b.cancelEvent(c)}}return this.touchMoveHandler},
touchEndHandler:null,getTouchEnd:function(){if(!this.touchEndHandler){var a=this;this.touchEndHandler=function(c){if(a.prevTouch&&c.touches.length==0){b.removeEvent(document,"touchend",a.getTouchEnd());b.removeEvent(document,"touchcancel",a.getTouchEnd());b.removeEvent(document,"touchmove",a.getTouchMove());a.prevTouch=null}return b.cancelEvent(c)}}return this.touchEndHandler},doubleTapHandler:null,getDoubleTap:function(){if(!this.doubleTapHandler){var a=this,c=null,e=0;this.doubleTapHandler=function(d){if(d.touches.length==
1){d=new b.Point(d.touches[0].pageX,d.touches[0].pageY);if(c){var f;f=d.x-c.x;var g=d.y-c.y;f=f*f+g*g;g=(new Date).getTime()-e;f<100&&g<400&&a.map.zoomByAbout(1,d)}c=d;e=(new Date).getTime()}}}return this.doubleTapHandler}}})(com.modestmaps);
