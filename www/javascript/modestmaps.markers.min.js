if(!com)var com={};if(!com.modestmaps)com.modestmaps={};
com.modestmaps.Markers=function(b){this.drawn=[];this.modestmap=b;this.container=b.parent;this.div=document.createElement("div");this.div.setAttribute("id","modestmaps_markers");this.div.style.position="absolute";this.div.style.left="0px";this.div.style.top="0px";this.div.style.zIndex="200";this.container.appendChild(this.div);this.canvas=Raphael(this.div,this.container.offsetWidth,this.container.offsetHeight);var a=this;this.modestmap.addCallback("drawn",function(){a._redrawMarkers()});this.modestmap.addCallback("resized",
function(){a.surface.width=a.container.offsetWidth;a.surface.height=a.container.offsetHeight;a._redrawMarkers()})};com.modestmaps.Markers.prototype.drawPoints=function(b,a){var c=this._locatifyLatLons(b),d=c[0];c=c[1];this._registerMarker({type:"point",locations:d,extent:c,more:a});return this._actuallyDrawPoints(d,c,a)};
com.modestmaps.Markers.prototype.drawLines=function(b,a){var c=this._locatifyLatLons(b),d=c[0];this._registerMarker({type:"line",locations:d,extent:c[1],more:a});return this._actuallyDrawLines(d,draw_extent,a)};com.modestmaps.Markers.prototype.drawPolygons=function(b,a){var c=this._locatifyLatLons(b),d=c[0];c=c[1];this._registerMarker({type:"polygon",locations:d,extent:c,more:a});return this._actuallyDrawPolygons(d,c,a)};
com.modestmaps.Markers.prototype.drawBoundingBoxes=function(b,a){for(var c=a&&a.delimeter?a.delimeter:" ",d=[],e=b.length,f=0;f<e;f++){var g=b[f].split(c),k=[g[0],g[1]];g=[g[2],g[3]];var m=[g[0],k[1]],h=[k[0],g[1]];d.push([[k[0],k[1]],[m[0],m[1]],[g[0],g[1]],[h[0],h[1]],[k[0],k[1]]])}return this.drawPolygons(d,a)};
com.modestmaps.Markers.prototype.drawGeoJson=function(b,a){a||(a={});for(var c=[],d=b.length,e=0;e<d;e++){var f=b[e],g={};for(key in a)g[key]=a[key];g.properties=f.properties;f=f.geometry.type=="GeometryCollection"?f.geometry.geometries:[f.geometry];for(var k=f.length,m=0;m<k;m++){var h=f[m].type,l=f[m].coordinates;l=this._lonlat2latlon(l);if(h=="Point"||h=="MultiPoint"){if(h=="Point")l=[l];h=this.drawPoints(l,g);c.push(h)}else if(h=="Polygon"||h=="MultiPolygon"){h=this.drawPolygons(l,g);c.push(h)}else if(h==
"LineString"||h=="MultiLineString"){if(h=="LineString")l=[l];h=this.drawLines(l,g);c.push(h)}}}return c};com.modestmaps.Markers.prototype.purgeMarkers=function(b){if(b){if(b>=this.drawn.length)return;this.drawn=this.drawn.slice(0,b)}else this.drawn=[];this._redrawMarkers()};com.modestmaps.Markers.prototype._lonlat2latlon=function(b,a){if(b){if(typeof b[0]=="number")return[b[1],b[0]];a=[];for(var c=b.length,d=0;d<c;d++)a.push(this._lonlat2latlon(b[d]));return a}};
com.modestmaps.Markers.prototype._locatifyLatLons=function(b){var a=[];for(i in b)if(typeof b[i][0]==="object"){var c=this._locatifyLatLons(b[i]);a.push(c[0])}else{c=new com.modestmaps.Location(b[i][0],b[i][1]);a.push(c)}b=this._extentForPoints(a);return Array(a,b)};
com.modestmaps.Markers.prototype._registerMarker=function(b){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var d=Math.random()*16|0;return(c=="x"?d:d&3|8).toString(16)}).toUpperCase();a="marker-"+a;b.id=a;this.drawn.push(b);return a};com.modestmaps.Markers.prototype._scrubSurface=function(){this.canvas.clear()};
com.modestmaps.Markers.prototype._redrawMarkers=function(){this._scrubSurface();var b=this.modestmap.getExtent(),a=this.modestmap.getZoom();for(i in this.drawn){var c=this.drawn[i].type,d=this.drawn[i].locations,e=this.drawn[i].more;if(c=="point"&&a<14)this._actuallyDrawPoints(d,b,e);else if(c=="line")this._actuallyDrawLines(d,b,e);else c=="polygon"&&this._actuallyDrawPolygons(d,b,e)}};
com.modestmaps.Markers.prototype._actuallyDrawLines=function(b,a,c){a=[];for(var d in b){var e=[],f=b[d];if(f.length==1)f=f[0];for(var g in f){var k=this.modestmap.locationPoint(f[g]);e.push({x:k.x,y:k.y})}e=this._line(e,c);a.push(e)}return e};com.modestmaps.Markers.prototype._actuallyDrawPolygons=function(b,a,c){a=[];for(var d in b){var e=[],f=b[d];if(f.length==1)f=f[0];for(var g in f){var k=this.modestmap.locationPoint(f[g]);e.push({x:k.x,y:k.y})}e=this._polygon(e,c);a.push(e)}return a};
com.modestmaps.Markers.prototype._actuallyDrawPoints=function(b,a,c){a=[];for(i in b){var d=this.modestmap.locationPoint(b[i]);d=this._circle({x:d.x,y:d.y},c);a.push(d)}return a};com.modestmaps.Markers.prototype._radiusByZoomLevel=function(){return 5};
com.modestmaps.Markers.prototype._extentForDrawnPoints=function(){var b=undefined,a=undefined,c=undefined,d=undefined;for(i in this.drawn){var e=this.drawn[i].extent[0],f=this.drawn[i].extent[1];b=b===undefined?e.lat:Math.min(b,e.lat);a=a===undefined?e.lon:Math.min(a,e.lon);c=c===undefined?f.lat:Math.max(c,f.lat);d=d===undefined?f.lon:Math.max(d,f.lon)}e=new com.modestmaps.Location(b,a);f=new com.modestmaps.Location(c,d);return Array(e,f)};
com.modestmaps.Markers.prototype._extentForPoints=function(b){var a=b,c=undefined,d=undefined,e=b=undefined;if(typeof a[0].lat==="undefined"){var f=[];for(i in a)for(j in a[i])f.push(a[i][j]);a=f}for(i in a){c=c===undefined?a[i].lat:Math.min(c,a[i].lat);d=d===undefined?a[i].lon:Math.min(d,a[i].lon);b=b===undefined?a[i].lat:Math.max(b,a[i].lat);e=e===undefined?a[i].lon:Math.max(e,a[i].lon)}a=new com.modestmaps.Location(c,d);b=new com.modestmaps.Location(b,e);return Array(a,b)};
com.modestmaps.Markers.prototype._calculateDrawExtent=function(b,a){if(typeof a==="undefined")return this.modestmap.getExtent();var c=a.extentify_all?this.extentForDrawnPoints():b;a.extentify_redraw&&this.modestmap.setExtent(c);return c};
com.modestmaps.Markers.prototype._enpointifyByExtent=function(b,a){var c=this.modestmap.getExtent(),d=[];for(i in b){var e=b[i];if(typeof e.lat!=="number"){e=this._enpointifyByExtent(e,a);d.push(e)}else if(this._isContainedBy(e,a))if(this._isContainedBy(e,c)){e=this.modestmap.locationPoint(e);d.push(e)}}return d};com.modestmaps.Markers.prototype._isContainedBy=function(){return true};
com.modestmaps.Markers.prototype._polygon=function(b,a){for(var c=b.length,d=["M"+b[0].x+" "+b[0].y],e=1;e<c;e++)d.push("L"+b[e].x+" "+b[e].y);d.push("Z");return this._decorate(this.canvas.path(d.join("")),a)};com.modestmaps.Markers.prototype._line=function(b,a){for(var c=b.length,d=["M"+b[0].x+" "+b[0].y],e=1;e<c;e++)d.push("L"+b[e].x+" "+b[e].y);return this._decorate(this.canvas.path(d.join("")),a)};
com.modestmaps.Markers.prototype._circle=function(b,a){return this._decorate(this.canvas.circle(b.x,b.y,a&&a.radius?a.radius:8),a)};com.modestmaps.Markers.prototype._decorate=function(b,a){a&&a.attrs&&b.attr(a.attrs);a&&a.onload&&a.onload(b,a.properties);return b};
